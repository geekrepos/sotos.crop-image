/*! 
 Name        : sotos.crop-image 
 Version     : 0.0.5 
 Author      :  - 
 Date        : 17-09-2015 
 Description : crop images, put watermark and save directive in angular  
 Homepage    : https://github.com/sotospez/sotos.crop-image#readme 
 Demopage    : http://sotos.gr/demos/crop-image/ 
 */
angular.module("sotos.crop-image",[]),angular.module("sotos.crop-image").directive("imageCrop",[function(){return{restrict:"E",transclude:!0,scope:{cropOptions:"=cropOptions",imageOut:"=",cropImageSave:"&"},controller:["$scope",function(a){var b,c,d,e,f,g,h,i,j=new Image;j.setAttribute("crossOrigin","anonymous");var k=new Image;k.setAttribute("crossOrigin","anonymous");var l,m,n=0,o=this;a.cropOptions=a.cropOptions||{},a.cropOptions.viewSizeWidth=a.cropOptions.viewSizeWidth||480,a.cropOptions.viewSizeHeight=a.cropOptions.viewSizeHeight||360,a.cropOptions.viewSizeFixed=a.cropOptions.viewSizeFixed||!1,a.cropOptions.viewShowFixedBtn=!1,a.cropOptions.viewShowRotateBtn=a.cropOptions.viewShowRotateBtn||!0,a.cropOptions.outputImageWidth=a.cropOptions.outputImageWidth||0,a.cropOptions.outputImageHeight=a.cropOptions.outputImageHeight||0,a.cropOptions.outputImageRatioFixed=a.cropOptions.outputImageRatioFixed||!0,a.cropOptions.outputImageType=a.cropOptions.outputImageType||"jpeg",a.cropOptions.outputImageSelfSizeCrop=a.cropOptions.outputImageSelfSizeCrop||!0,a.cropOptions.viewShowCropTool=a.cropOptions.viewShowCropTool||!0,a.cropOptions.watermarkType=a.cropOptions.watermarkType||"text",a.cropOptions.watermarkImage=a.cropOptions.watermarkImage||null,a.cropOptions.watermarkText=a.cropOptions.watermarkText||null,a.cropOptions.watermarkTextFillColor=a.cropOptions.watermarkTextFillColor||"rgba(0,0, 0, 0.8)",a.cropOptions.watermarkTextStrokeColor=a.cropOptions.watermarkTextFillColor||"rgba(255,0, 0, 0.8)",a.cropOptions.watermarkTextStrokeLineWidth=a.cropOptions.watermarkTextStrokeLineWidth||1,a.cropOptions.watermarkTextFont=a.cropOptions.watermarkTextFont||"Arial",a.cropOptions.inModal=a.cropOptions.inModal||!1,this.inModal=a.cropOptions.inModal,"jpg"===a.cropOptions.outputImageType&&(m="image/jpeg"),"jpeg"===a.cropOptions.outputImageType&&(m="image/jpeg"),"png"===a.cropOptions.outputImageType&&(m="image/png");var p=function(a,b,c,d){this.x=a,this.y=b,this.w=c,this.h=d,this.px=a,this.py=b,this.csize=6,this.csizeh=10,this.bHow=[!1,!1,!1,!1,!1],this.iCSize=[this.csize,this.csize,this.csize,this.csize,this.csize],this.bDrag=[!1,!1,!1,!1,!1],this.bDragAll=!1,this.rotateCenter={},this.rotateCenter.angle=.005,this.rotateCenter.angleRotate=1,this.rotateCenter.isrotate=!1,this.rotateCenter.r=this.w>this.h?this.w:this.h,this.rotateCenter.r=this.rotateCenter.r/Math.PI,this.rotateCenter.x=this.x+this.w/2,this.rotateCenter.sx=this.rotateCenter.x+this.rotateCenter.r*Math.cos(this.rotateCenter.angle),this.rotateCenter.y=this.y+this.h/2,this.rotateCenter.sy=this.rotateCenter.y+this.rotateCenter.r*Math.sin(this.rotateCenter.angle),this.ratioHover=!1,this.ratioOn=!1,this.ratioSize=6,this.sizeOutRatio=0,this.watermarkTextSpace=20};p.prototype.drawRatio=function(){a.cropOptions.viewShowFixedBtn&&(f.lineWidth=1,f.strokeStyle="#eee",f.font="20px Arial",f.fillStyle="#eee",f.fillText("Ratio",8,60),f.beginPath(),f.arc(65,55,this.ratioSize,0,2*Math.PI,!1),a.cropOptions.outputImageRatioFixed&&(f.fillStyle="rgba(51,184, 229, 0.9)",f.fill()),f.lineWidth=3,f.strokeStyle="rgba(0,153, 205, 0.8)",f.stroke())},p.prototype.drawWaterMarkImage=function(){this.w>this.h?this.h=this.w/n:this.w=this.h*n,f.drawImage(k,this.x,this.y,this.w,this.h),f.strokeStyle="#000",f.lineWidth=2,f.strokeRect(this.x,this.y,this.w,this.h),this.w>0&&this.h>0&&(g.clearRect(0,0,d.width,d.height),i.drawImage(k,this.x*l,this.y*l,this.w*l,this.h*l),g.drawImage(e,0,0,d.width,d.height)),f.fillStyle="rgba(119,206, 238, 0.9)",f.fillRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.fillRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.fillRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.fillRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3]),f.lineWidth=1,f.strokeRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.strokeRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.strokeRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.strokeRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3])},p.prototype.drawWaterMarkText=function(){if(f.font=this.h+"px "+a.cropOptions.watermarkTextFont,f.fillStyle=a.cropOptions.watermarkTextFillColor,f.fillText(a.cropOptions.watermarkText,this.x+this.watermarkTextSpace,this.y+this.h-this.h/4,this.w-this.watermarkTextSpace-this.watermarkTextSpace),f.strokeStyle="#000",f.lineWidth=2,f.strokeRect(this.x,this.y,this.w,this.h),this.w>0&&this.h>0){g.clearRect(0,0,d.width,d.height),i.lineWidth=a.cropOptions.watermarkTextStrokeLineWidth,i.strokeStyle=a.cropOptions.watermarkTextFillColor;var b=this.h*l;i.font=b+"px "+a.cropOptions.watermarkTextFont,i.fillStyle=a.cropOptions.watermarkTextFillColor,i.fillText(a.cropOptions.watermarkText,(this.x+this.watermarkTextSpace)*l,(this.y+this.h-this.h/4)*l,(this.w-this.watermarkTextSpace-this.watermarkTextSpace)*l),g.drawImage(e,0,0,d.width,d.height)}f.fillStyle="rgba(119,206, 238, 0.9)",f.fillRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.fillRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.fillRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.fillRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3]),f.lineWidth=1,f.strokeRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.strokeRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.strokeRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.strokeRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3])},p.prototype.drawRotate=function(){a.cropOptions.viewShowRotateBtn&&(this.rotateCenter.r=this.w>this.h?this.w:this.h,this.rotateCenter.r=Math.floor(this.rotateCenter.r/Math.PI),this.rotateCenter.x=Math.floor(this.x+this.w/2),this.rotateCenter.sx=Math.floor(this.rotateCenter.x+this.rotateCenter.r*Math.cos(this.rotateCenter.angleRotate)),this.rotateCenter.y=Math.floor(this.y+this.h/2),this.rotateCenter.sy=Math.floor(this.rotateCenter.y+this.rotateCenter.r*Math.sin(this.rotateCenter.angleRotate)),f.beginPath(),f.arc(this.rotateCenter.x,this.rotateCenter.y,this.rotateCenter.r,0,2*Math.PI,!1),f.lineWidth=5,f.strokeStyle="rgba(200,200, 200, 0.5)",f.stroke(),f.closePath(),f.beginPath(),f.arc(this.rotateCenter.x,this.rotateCenter.y,this.rotateCenter.r,0,this.rotateCenter.angleRotate,!1),f.lineWidth=5,f.strokeStyle="rgba(153, 205,0, 0.8)",f.stroke(),f.closePath(),f.beginPath(),f.arc(this.rotateCenter.sx,this.rotateCenter.sy,this.iCSize[4],0,2*Math.PI,!1),f.fillStyle="rgba(51,184, 229,0.8)",f.fill(),f.lineWidth=5,f.strokeStyle="rgba(0, 153,204, 0.6)",f.stroke(),f.closePath())},p.prototype.draw=function(){this.sizeOutRatio=a.cropOptions.outputImageWidth/a.cropOptions.outputImageHeight,a.cropOptions.outputImageRatioFixed&&(this.w>this.h?this.h=this.w/this.sizeOutRatio:this.w=this.h*this.sizeOutRatio),f.fillStyle="rgba(0, 0, 0, 0.5)",f.fillRect(0,0,f.canvas.width,f.canvas.height),f.strokeStyle="#000",f.lineWidth=2,f.strokeRect(this.x,this.y,this.w,this.h),this.w>0&&this.h>0&&(f.drawImage(d,this.x,this.y,this.w,this.h,this.x,this.y,this.w,this.h),g.clearRect(0,0,d.width,d.height),g.drawImage(e,this.x*l,this.y*l,this.w*l,this.h*l,this.x,this.y,this.w,this.h)),f.fillStyle="rgba(119,206, 238, 0.9)",f.fillRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.fillRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.fillRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.fillRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3]),f.lineWidth=1,f.strokeRect(this.x-this.iCSize[0],this.y-this.iCSize[0],2*this.iCSize[0],2*this.iCSize[0]),f.strokeRect(this.x+this.w-this.iCSize[1],this.y-this.iCSize[1],2*this.iCSize[1],2*this.iCSize[1]),f.strokeRect(this.x+this.w-this.iCSize[2],this.y+this.h-this.iCSize[2],2*this.iCSize[2],2*this.iCSize[2]),f.strokeRect(this.x-this.iCSize[3],this.y+this.h-this.iCSize[3],2*this.iCSize[3],2*this.iCSize[3])},this.drawScene=function(){f.clearRect(0,0,f.canvas.width,f.canvas.height),f.drawImage(j,0,0,f.canvas.width,f.canvas.height),h.save(),i.save(),h.clearRect(0,0,f.canvas.width,f.canvas.height),i.clearRect(0,0,j.width,j.height),h.translate(d.width/2,d.height/2),i.translate(j.width/2,j.height/2),h.rotate(q.rotateCenter.angleRotate),i.rotate(q.rotateCenter.angleRotate),h.drawImage(j,-b.width/2,-b.height/2,b.width,b.height),i.drawImage(j,-j.width/2,-j.height/2,j.width,j.height),h.restore(),i.restore(),a.cropOptions.viewShowCropTool?(q.x<0&&(q.x=0),q.y<0&&(q.y=0),q.x+q.w>f.canvas.width&&(q.x=f.canvas.width-q.w),q.y+q.h>f.canvas.height&&(q.y=f.canvas.height-q.h),q.draw(),q.drawRotate()):("image"===a.cropOptions.watermarkType&&(a.cropOptions.watermarkImage?q.drawWaterMarkImage():(g.clearRect(0,0,d.width,d.height),g.drawImage(e,0,0,d.width,d.height))),"text"===a.cropOptions.watermarkType&&(angular.isString(a.cropOptions.watermarkText)?q.drawWaterMarkText():(g.clearRect(0,0,d.width,d.height),g.drawImage(e,0,0,d.width,d.height))))},this.getEditCanvas=function(){return b},this.getViewCanvas=function(){return c},this.getImage=function(){if(a.cropOptions.viewShowCropTool){var b,c;c=document.createElement("canvas"),b=c.getContext("2d"),a.cropOptions.outputImageRatioFixed?(c.width=a.cropOptions.outputImageWidth,c.height=a.cropOptions.outputImageHeight):q.w>q.h?(c.width=q.w/(q.w/a.cropOptions.outputImageWidth),c.height=q.h/(q.w/a.cropOptions.outputImageWidth)):(c.width=q.w/(q.h/a.cropOptions.outputImageHeight),c.height=q.h/(q.h/a.cropOptions.outputImageHeight)),a.cropOptions.outputImageSelfSizeCrop&&(c.width=q.w*l,c.height=q.h*l),b.drawImage(e,q.x*l,q.y*l,q.w*l,q.h*l,0,0,c.width,c.height),a.cropOptions.image=c.toDataURL(m),a.imageOut=a.cropOptions.image,a.cropOptions.viewShowCropTool=!1}};var q=new p(50,50,50,50);b=document.createElement("canvas"),f=b.getContext("2d"),c=document.createElement("canvas"),g=c.getContext("2d"),d=document.createElement("canvas"),h=d.getContext("2d"),e=document.createElement("canvas"),i=e.getContext("2d"),j.onload=function(){q.rotateCenter.angleRotate=0,(0===a.cropOptions.outputImageWidth||0===a.cropOptions.outputImageHeight)&&(a.cropOptions.outputImageWidth=j.width,a.cropOptions.outputImageHeight=j.height),l=j.width/a.cropOptions.viewSizeWidth,j.width<j.height&&(l=j.height/a.cropOptions.viewSizeHeight),e.width=j.width,e.height=j.height,b.width=j.width/l,b.height=j.height/l,c.width=b.width,c.height=b.height,d.width=b.width,d.height=b.height,o.drawScene()},this.theSelection=q;var r=function(){j.src=a.cropOptions.image};k.onload=function(){n=k.width/k.height,q.x=b.width/4,q.y=b.height/5,q.w=b.width/2,q.h=b.width/2/n,o.drawScene()};var s=function(){a.cropOptions.watermarkImage?k.src=a.cropOptions.watermarkImage:(k.src=null,o.drawScene())};a.$watch("cropOptions.image",r),a.$watch("cropOptions.watermarkImage",s),a.$watch("cropOptions.watermarkText",r),a.$on("cropImageSave",function(){a.imageOut=e.toDataURL(m),a.cropImageSave()(a.imageOut)}),a.$on("cropImageShow",function(){a.imageOut=e.toDataURL(m)}),a.$on("cropImage",o.getImage),r()}]}}]),angular.module("sotos.crop-image").directive("editCrop",[function(){return{require:"^imageCrop",restrict:"E",scope:!1,link:function(a,b,c,d){var e,f=0,g=1,h=!1,i=d.getEditCanvas(),j=function(a){a=a[0];var b=0,c=0;if(a.offsetParent){do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent);return{left:b,top:c}}},k=function(a){e=j(b.children()),d.inModal?(f=Math.floor(a.clientX-e.left),g=Math.floor(a.clientY-e.top)):h?(f=Math.floor(a.targetTouches[0].pageX-e.left),g=Math.floor(a.targetTouches[0].pageY-e.top)):(f=Math.floor(a.pageX-e.left),g=Math.floor(a.pageY-e.top)),d.theSelection.rotateCenter.isrotate=!1,d.theSelection.bDragAll&&(d.theSelection.x=f-d.theSelection.px,d.theSelection.y=g-d.theSelection.py);for(var c=0;5>c;c++)d.theSelection.bHow[c]=!1,d.theSelection.iCSize[c]=d.theSelection.csize;d.theSelection.ratioHover=!1,d.theSelection.ratioSize=6,f>d.theSelection.x-d.theSelection.csizeh&&f<d.theSelection.x+d.theSelection.csizeh&&g>d.theSelection.y-d.theSelection.csizeh&&g<d.theSelection.y+d.theSelection.csizeh&&(d.theSelection.bHow[0]=!0,d.theSelection.iCSize[0]=d.theSelection.csizeh),f>d.theSelection.x+d.theSelection.w-d.theSelection.csizeh&&f<d.theSelection.x+d.theSelection.w+d.theSelection.csizeh&&g>d.theSelection.y-d.theSelection.csizeh&&g<d.theSelection.y+d.theSelection.csizeh&&(d.theSelection.bHow[1]=!0,d.theSelection.iCSize[1]=d.theSelection.csizeh),f>d.theSelection.x+d.theSelection.w-d.theSelection.csizeh&&f<d.theSelection.x+d.theSelection.w+d.theSelection.csizeh&&g>d.theSelection.y+d.theSelection.h-d.theSelection.csizeh&&g<d.theSelection.y+d.theSelection.h+d.theSelection.csizeh&&(d.theSelection.bHow[2]=!0,d.theSelection.iCSize[2]=d.theSelection.csizeh),f>d.theSelection.x-d.theSelection.csizeh&&f<d.theSelection.x+d.theSelection.csizeh&&g>d.theSelection.y+d.theSelection.h-d.theSelection.csizeh&&g<d.theSelection.y+d.theSelection.h+d.theSelection.csizeh&&(d.theSelection.bHow[3]=!0,d.theSelection.iCSize[3]=d.theSelection.csizeh),f>d.theSelection.rotateCenter.sx-d.theSelection.csizeh&&f<d.theSelection.rotateCenter.sx+d.theSelection.csizeh&&g>d.theSelection.rotateCenter.sy-d.theSelection.csizeh&&g<d.theSelection.rotateCenter.sy+d.theSelection.csizeh&&(d.theSelection.bHow[4]=!0,d.theSelection.iCSize[4]=d.theSelection.csizeh),f>40&&70>f&&g>50&&60>g&&(d.theSelection.ratioHover=!0,d.theSelection.ratioSize=10);var i,k,l,m;d.theSelection.bDrag[0]&&(l=f-d.theSelection.px,m=g-d.theSelection.py,i=d.theSelection.w+d.theSelection.x-l,k=d.theSelection.h+d.theSelection.y-m),d.theSelection.bDrag[1]&&(l=d.theSelection.x,m=g-d.theSelection.py,i=f-d.theSelection.px-l,k=d.theSelection.h+d.theSelection.y-m),d.theSelection.bDrag[2]&&(l=d.theSelection.x,m=d.theSelection.y,i=f-d.theSelection.px-l,k=g-d.theSelection.py-m),d.theSelection.bDrag[3]&&(l=f-d.theSelection.px,m=d.theSelection.y,i=d.theSelection.w+d.theSelection.x-l,k=g-d.theSelection.py-m),d.theSelection.bDrag[4]&&(d.theSelection.rotateCenter.isrotate=!0,d.theSelection.rotateCenter.angleRotate=Math.atan2(g-d.theSelection.rotateCenter.y,f-d.theSelection.rotateCenter.x)),i>2*d.theSelection.csizeh&&k>2*d.theSelection.csizeh&&(d.theSelection.w=i,d.theSelection.h=k,d.theSelection.x=l,d.theSelection.y=m),d.drawScene()},l=function(a){e=j(b.children()),d.inModal?(f=Math.floor(a.clientX-e.left),g=Math.floor(a.clientY-e.top)):h?(f=Math.floor(a.targetTouches[0].pageX-e.left),g=Math.floor(a.targetTouches[0].pageY-e.top)):(f=Math.floor(a.pageX-e.left),g=Math.floor(a.pageY-e.top)),d.theSelection.px=f-d.theSelection.x,d.theSelection.py=g-d.theSelection.y,d.theSelection.bHow[0]&&(d.theSelection.px=f-d.theSelection.x,d.theSelection.py=g-d.theSelection.y),d.theSelection.bHow[1]&&(d.theSelection.px=f-d.theSelection.x-d.theSelection.w,d.theSelection.py=g-d.theSelection.y),d.theSelection.bHow[2]&&(d.theSelection.px=f-d.theSelection.x-d.theSelection.w,d.theSelection.py=g-d.theSelection.y-d.theSelection.h),d.theSelection.bHow[3]&&(d.theSelection.px=f-d.theSelection.x,d.theSelection.py=g-d.theSelection.y-d.theSelection.h),d.theSelection.ratioHover&&(d.theSelection.ratioOn=!d.theSelection.ratioOn),f>d.theSelection.x+d.theSelection.csizeh&&f<d.theSelection.x+d.theSelection.w-d.theSelection.csizeh&&g>d.theSelection.y+d.theSelection.csizeh&&g<d.theSelection.y+d.theSelection.h-d.theSelection.csizeh&&(d.theSelection.bHow[4]||(d.theSelection.bDragAll=!0));for(var c=0;5>c;c++)d.theSelection.bHow[c]&&(d.theSelection.bDrag[c]=!0)},m=function(a){d.theSelection.bDragAll=!1;for(var b=0;5>b;b++)d.theSelection.bDrag[b]=!1;d.theSelection.px=0,d.theSelection.py=0},n=function(a){h=!0,l(a)},o=function(a){h=!0,k(a)},p=function(a){h=!1,m(a)};b.bind("mousemove",k),b.bind("mousedown",l),b.bind("mouseup",m),b.bind("touchstart",n),b.bind("touchmove",o),b.bind("touchend",p),b.bind("dblclick",d.getImage),b.append(i)}}}]),angular.module("sotos.crop-image").directive("viewCrop",[function(){return{require:"^imageCrop",restrict:"E",scope:!1,link:function(a,b,c,d){b.append(d.getViewCanvas())}}}]);